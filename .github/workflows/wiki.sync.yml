name: Synchronizace Wiki (content/wiki + public/wiki → AgoniaWeb)

on:
  push:
    branches: [ main ]
    paths:
      - 'content/wiki/**'
      - 'public/wiki/**'
  workflow_dispatch: {}  # ruční spuštění z Actions

permissions:
  contents: read

concurrency:
  group: wiki-sync
  cancel-in-progress: true  # zruší předchozí běh, pokud přijde nový

jobs:
  # 1) Manuální schválení (environment gate)
  approval:
    name: Čeká na schválení synchronizace
    runs-on: ubuntu-latest
    environment:
      name: wiki-sync  # vytvoř v Settings → Environments → Required reviewers
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    steps:
      - name: Informace o změnách
        run: |
          echo "📝 Synchronizace wiki do WolverStones/AgoniaWeb"
          echo "📦 Commit: ${{ github.sha }}"
          echo "👤 Autor: ${{ github.actor }}"
          echo "⏸️  Čeká se na manuální schválení..."

  # 2) Synchronizace (spustí se až po schválení)
  sync:
    name: Synchronizace do AgoniaWeb
    runs-on: ubuntu-latest
    needs: approval
    steps:
      - name: Checkout zdrojového repo
        uses: actions/checkout@v4

      - name: Klonování cílového repozitáře
        run: |
          git clone "https://x-access-token:${{ secrets.PRIVATE_REPO_TOKEN }}@github.com/WolverStones/AgoniaWeb.git" target
          cd target
          git config user.name "Wiki Sync Bot"
          git config user.email "actions@github.com"

      - name: Synchronizace souborů
        run: |
          # Zajisti existenci cílových složek
          mkdir -p target/frontend/content/wiki
          mkdir -p target/frontend/public/wiki
          
          # Sync MDX souborů
          if [ -d content/wiki ]; then
            echo "📄 Kopíruji content/wiki..."
            rsync -av --delete content/wiki/ target/frontend/content/wiki/
          fi
          
          # Sync assetů
          if [ -d public/wiki ]; then
            echo "🖼️  Kopíruji public/wiki..."
            rsync -av --delete public/wiki/ target/frontend/public/wiki/
          fi

      - name: Commit a push změn
        run: |
          cd target
          
          # Zjisti výchozí větev
          DEFAULT_BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD | sed 's@^refs/remotes/origin/@@')
          
          git add frontend/content/wiki frontend/public/wiki
          
          # Pokud nejsou změny, skonči
          if git diff --cached --quiet; then
            echo "✅ Žádné změny k synchronizaci."
            exit 0
          fi
          
          # Commit s odkazem na zdrojový commit
          git commit -m "Wiki sync: ${{ github.event.head_commit.message }}

          Source: ${{ github.repository }}@${{ github.sha }}
          Author: ${{ github.actor }}
          
          [skip ci]"
          
          git push origin "$DEFAULT_BRANCH"
          echo "🚀 Synchronizace dokončena do větve $DEFAULT_BRANCH"

      - name: Výsledek
        if: success()
        run: |
          echo "✅ Wiki bylo úspěšně synchronizováno!"
          echo "📍 Repo: WolverStones/AgoniaWeb"
