name: Synchronizace Wiki (content/wiki + public/wiki â†’ AgoniaWeb)

on:
  push:
    branches: [ main ]
    paths:
      - 'content/wiki/**'
      - 'public/wiki/**'
  workflow_dispatch: {}  # ruÄnÃ­ spuÅ¡tÄ›nÃ­ z Actions

permissions:
  contents: read

concurrency:
  group: wiki-sync
  cancel-in-progress: true  # zruÅ¡Ã­ pÅ™edchozÃ­ bÄ›h, pokud pÅ™ijde novÃ½

jobs:
  # 1) ManuÃ¡lnÃ­ schvÃ¡lenÃ­ (environment gate)
  approval:
    name: ÄŒekÃ¡ na schvÃ¡lenÃ­ synchronizace
    runs-on: ubuntu-latest
    environment:
      name: wiki-sync  # vytvoÅ™ v Settings â†’ Environments â†’ Required reviewers
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    steps:
      - name: Informace o zmÄ›nÃ¡ch
        run: |
          echo "ğŸ“ Synchronizace wiki do WolverStones/AgoniaWeb"
          echo "ğŸ“¦ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Autor: ${{ github.actor }}"
          echo "â¸ï¸  ÄŒekÃ¡ se na manuÃ¡lnÃ­ schvÃ¡lenÃ­..."

  # 2) Synchronizace (spustÃ­ se aÅ¾ po schvÃ¡lenÃ­)
  sync:
    name: Synchronizace do AgoniaWeb
    runs-on: ubuntu-latest
    needs: approval
    steps:
      - name: Checkout zdrojovÃ©ho repo
        uses: actions/checkout@v4

      - name: KlonovÃ¡nÃ­ cÃ­lovÃ©ho repozitÃ¡Å™e
        run: |
          git clone "https://x-access-token:${{ secrets.PRIVATE_REPO_TOKEN }}@github.com/WolverStones/AgoniaWeb.git" target
          cd target
          git config user.name "Wiki Sync Bot"
          git config user.email "actions@github.com"

      - name: Synchronizace souborÅ¯
        run: |
          # Zajisti existenci cÃ­lovÃ½ch sloÅ¾ek
          mkdir -p target/frontend/content/wiki
          mkdir -p target/frontend/public/wiki
          
          # Sync MDX souborÅ¯
          if [ -d content/wiki ]; then
            echo "ğŸ“„ KopÃ­ruji content/wiki..."
            rsync -av --delete content/wiki/ target/frontend/content/wiki/
          fi
          
          # Sync assetÅ¯
          if [ -d public/wiki ]; then
            echo "ğŸ–¼ï¸  KopÃ­ruji public/wiki..."
            rsync -av --delete public/wiki/ target/frontend/public/wiki/
          fi

      - name: Commit a push zmÄ›n
        run: |
          cd target
          
          # Zjisti vÃ½chozÃ­ vÄ›tev
          DEFAULT_BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD | sed 's@^refs/remotes/origin/@@')
          
          git add frontend/content/wiki frontend/public/wiki
          
          # Pokud nejsou zmÄ›ny, skonÄi
          if git diff --cached --quiet; then
            echo "âœ… Å½Ã¡dnÃ© zmÄ›ny k synchronizaci."
            exit 0
          fi
          
          # Commit s odkazem na zdrojovÃ½ commit
          git commit -m "Wiki sync: ${{ github.event.head_commit.message }}

          Source: ${{ github.repository }}@${{ github.sha }}
          Author: ${{ github.actor }}
          
          [skip ci]"
          
          git push origin "$DEFAULT_BRANCH"
          echo "ğŸš€ Synchronizace dokonÄena do vÄ›tve $DEFAULT_BRANCH"

      - name: VÃ½sledek
        if: success()
        run: |
          echo "âœ… Wiki bylo ÃºspÄ›Å¡nÄ› synchronizovÃ¡no!"
          echo "ğŸ“ Repo: WolverStones/AgoniaWeb"
