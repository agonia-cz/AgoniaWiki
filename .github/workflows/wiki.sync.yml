# .github/workflows/wiki-sync.yml
name: Synchronizace Wiki (content/wiki + public/wiki â†’ AgoniaWeb, se schvÃ¡lenÃ­m)

on:
  push:
    branches: [ main ]
    paths:
      - 'content/wiki/**'
      - 'public/wiki/**'
  schedule:
    - cron: '*/30 * * * *'  # volitelnÃ©: kaÅ¾dÃ½ch 30 minut
  workflow_dispatch: {}      # ruÄnÃ­ spuÅ¡tÄ›nÃ­ z Actions

permissions:
  contents: read

concurrency:
  group: wiki-sync-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # 1) Detekce zmÄ›n
  detect:
    name: Detekce zmÄ›n ve wiki
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.check.outputs.changed }}
    steps:
      - name: Checkout (veÅ™ejnÃ© AgoniaWiki)
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Kontrola zmÄ›n ve wiki
        id: check
        run: |
          set -e
          # Pro workflow_dispatch vÅ¾dy pokraÄuj
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "ğŸ”” ManuÃ¡lnÃ­ spuÅ¡tÄ›nÃ­ - pokraÄuji se synchronizacÃ­."
            exit 0
          fi
          
          # Pro schedule event kontroluj, jestli byly zmÄ›ny od poslednÃ­ ÃºspÄ›Å¡nÃ© synchronizace
          if [ "${{ github.event_name }}" = "schedule" ]; then
            # Zkus najÃ­t poslednÃ­ ÃºspÄ›Å¡nÃ½ sync commit
            LAST_SYNC=$(git log --grep="Synchronizace wiki:" --format="%H" -1 2>/dev/null || echo "")
            
            if [ -n "$LAST_SYNC" ]; then
              CHANGED=$(git diff --name-only "$LAST_SYNC" HEAD -- content/wiki public/wiki | wc -l)
              if [ "$CHANGED" -gt 0 ]; then
                echo "changed=true" >> "$GITHUB_OUTPUT"
                echo "ğŸ”” Schedule: DetekovÃ¡no $CHANGED zmÄ›n od poslednÃ­ho syncu."
              else
                echo "changed=false" >> "$GITHUB_OUTPUT"
                echo "âœ… Schedule: Å½Ã¡dnÃ© novÃ© zmÄ›ny od poslednÃ­ho syncu."
                exit 0
              fi
            else
              echo "changed=true" >> "$GITHUB_OUTPUT"
              echo "ğŸ”” Schedule: PrvnÃ­ sync, pokraÄuji."
            fi
            exit 0
          fi
          
          # Pro push event kontroluj zmÄ›ny
          if [ -z "${{ github.event.before }}" ] || [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            CHANGED=$(git diff --name-only HEAD~1 HEAD -- content/wiki public/wiki 2>/dev/null | wc -l || echo "1")
          else
            CHANGED=$(git diff --name-only "${{ github.event.before }}" "${{ github.sha }}" -- content/wiki public/wiki | wc -l)
          fi
          
          if [ "$CHANGED" -gt 0 ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "ğŸ”” DetekovÃ¡no $CHANGED zmÄ›nÄ›nÃ½ch souborÅ¯ ve wiki."
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "âœ… Å½Ã¡dnÃ© zmÄ›ny ve wiki."
          fi

  # 2) ManuÃ¡lnÃ­ schvÃ¡lenÃ­ pÅ™es Environment gate
  approval:
    name: ÄŒekÃ¡ na manuÃ¡lnÃ­ schvÃ¡lenÃ­
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.changed == 'true'
    environment:
      name: wiki-sync     # â† vytvoÅ™ v Settings â†’ Environments a nastav Required reviewers
      url: https://github.com/agonia-cz/AgoniaWiki/actions
    steps:
      - run: echo "â¸ï¸ ÄŒekÃ¡ se na manuÃ¡lnÃ­ schvÃ¡lenÃ­ (environment protection)."

  # 3) Synchronizace po schvÃ¡lenÃ­
  sync:
    name: Synchronizace do WolverStones/AgoniaWeb
    runs-on: ubuntu-latest
    needs: approval
    steps:
      - name: Checkout (veÅ™ejnÃ© AgoniaWiki)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: KlonovÃ¡nÃ­ privÃ¡tnÃ­ho repozitÃ¡Å™e (cÃ­lovÃ©)
        run: |
          set -e
          git clone "https://x-access-token:${{ secrets.PRIVATE_REPO_TOKEN }}@github.com/WolverStones/AgoniaWeb.git" private
          cd private
          git config user.name "Agonia Wiki Sync Bot"
          git config user.email "actions@github.com"
          
          # Pro schedule event zkontroluj, jestli uÅ¾ nenÃ­ vÅ¡e synchronizovanÃ©
          if [ "${{ github.event_name }}" = "schedule" ]; then
            if [ -f ".wiki-sync-marker" ]; then
              LAST_SYNCED=$(cat .wiki-sync-marker)
              CURRENT_HASH="${{ github.sha }}"
              if [ "$LAST_SYNCED" = "$CURRENT_HASH" ]; then
                echo "âœ… Wiki uÅ¾ je synchronizovanÃ© (hash: $CURRENT_HASH)"
                echo "SKIP_SYNC=true" >> "$GITHUB_ENV"
              fi
            fi
          fi

      - name: ZajiÅ¡tÄ›nÃ­ existence cÃ­lovÃ½ch sloÅ¾ek
        run: |
          if [ "$SKIP_SYNC" = "true" ]; then
            echo "â­ï¸ PÅ™eskakuji synchronizaci - uÅ¾ je aktuÃ¡lnÃ­"
            exit 0
          fi
          mkdir -p private/frontend/content/wiki
          mkdir -p private/frontend/public/wiki

      - name: Synchronizace content/wiki (MDX) â†’ frontend/content/wiki
        run: |
          if [ "$SKIP_SYNC" = "true" ]; then exit 0; fi
          if [ -d content/wiki ]; then
            rsync -av --delete --exclude='.git' content/wiki/ private/frontend/content/wiki/
          else
            echo "âš ï¸ Ve zdroji neexistuje sloÅ¾ka content/wiki."
          fi

      - name: Synchronizace public/wiki (assety) â†’ frontend/public/wiki
        run: |
          if [ "$SKIP_SYNC" = "true" ]; then exit 0; fi
          if [ -d public/wiki ]; then
            rsync -av --delete --exclude='.git' public/wiki/ private/frontend/public/wiki/
          else
            echo "âš ï¸ Ve zdroji neexistuje sloÅ¾ka public/wiki."
          fi

      - name: Commit a push zmÄ›n (pouze pokud existujÃ­)
        run: |
          set -e
          if [ "$SKIP_SYNC" = "true" ]; then exit 0; fi
          cd private
          
          # Zjisti vÃ½chozÃ­ vÄ›tev
          DEFAULT_BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD | sed 's@^refs/remotes/origin/@@')
          echo "ğŸ” ZjiÅ¡tÄ›nÃ¡ vÃ½chozÃ­ vÄ›tev: $DEFAULT_BRANCH"
          
          git add frontend/content/wiki frontend/public/wiki
          
          # UloÅ¾ marker s aktuÃ¡lnÃ­m hashem
          echo "${{ github.sha }}" > .wiki-sync-marker
          git add .wiki-sync-marker
          
          if git diff --cached --quiet; then
            echo "âœ… Å½Ã¡dnÃ© zmÄ›ny k odeslÃ¡nÃ­."
            exit 0
          fi
          
          COMMIT_MSG="Synchronizace wiki: content/wiki + public/wiki (schvÃ¡leno) [skip ci]
          
          ZdrojovÃ½ commit: ${{ github.sha }}"
          
          git commit -m "$COMMIT_MSG"
          git push origin "$DEFAULT_BRANCH"
          echo "ğŸš€ ZmÄ›ny ÃºspÄ›Å¡nÄ› odeslÃ¡ny do vÄ›tve $DEFAULT_BRANCH."
