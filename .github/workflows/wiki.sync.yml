# .github/workflows/wiki-sync.yml
name: Synchronizace Wiki (content/wiki + public/wiki ‚Üí AgoniaWeb, se schv√°len√≠m)

on:
  push:
    branches: [ main ]
    paths:
      - 'content/wiki/**'
      - 'public/wiki/**'
  schedule:
    - cron: '*/30 * * * *'  # voliteln√©: ka≈æd√Ωch 30 minut
  workflow_dispatch: {}      # ruƒçn√≠ spu≈°tƒõn√≠ z Actions

permissions:
  contents: read

concurrency:
  group: wiki-sync-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # 1) Detekce zmƒõn
  detect:
    name: Detekce zmƒõn ve wiki
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.check.outputs.changed }}
    steps:
      - name: Checkout (ve≈ôejn√© AgoniaWiki)
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Kontrola zmƒõn ve wiki
        id: check
        run: |
          set -e
          # Pro workflow_dispatch a schedule v≈ædy pokraƒçuj
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] || [ "${{ github.event_name }}" = "schedule" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "üîî Manu√°ln√≠/napl√°novan√© spu≈°tƒõn√≠ - pokraƒçuji se synchronizac√≠."
            exit 0
          fi
          
          # Pro push event kontroluj zmƒõny
          if [ -z "${{ github.event.before }}" ] || [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            CHANGED=$(git diff --name-only HEAD~1 HEAD -- content/wiki public/wiki 2>/dev/null | wc -l || echo "1")
          else
            CHANGED=$(git diff --name-only "${{ github.event.before }}" "${{ github.sha }}" -- content/wiki public/wiki | wc -l)
          fi
          
          if [ "$CHANGED" -gt 0 ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "üîî Detekov√°no $CHANGED zmƒõnƒõn√Ωch soubor≈Ø ve wiki."
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "‚úÖ ≈Ω√°dn√© zmƒõny ve wiki."
          fi

  # 2) Manu√°ln√≠ schv√°len√≠ p≈ôes Environment gate
  approval:
    name: ƒåek√° na manu√°ln√≠ schv√°len√≠
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.changed == 'true'
    environment:
      name: wiki-sync     # ‚Üê vytvo≈ô v Settings ‚Üí Environments a nastav Required reviewers
      url: https://github.com/agonia-cz/AgoniaWiki/actions
    steps:
      - run: echo "‚è∏Ô∏è ƒåek√° se na manu√°ln√≠ schv√°len√≠ (environment protection)."

  # 3) Synchronizace po schv√°len√≠
  sync:
    name: Synchronizace do WolverStones/AgoniaWeb
    runs-on: ubuntu-latest
    needs: approval
    steps:
      - name: Checkout (ve≈ôejn√© AgoniaWiki)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Klonov√°n√≠ priv√°tn√≠ho repozit√°≈ôe (c√≠lov√©)
        run: |
          set -e
          git clone "https://x-access-token:${{ secrets.PRIVATE_REPO_TOKEN }}@github.com/WolverStones/AgoniaWeb.git" private
          cd private
          git config user.name "Agonia Wiki Sync Bot"
          git config user.email "actions@github.com"

      - name: Zaji≈°tƒõn√≠ existence c√≠lov√Ωch slo≈æek
        run: |
          mkdir -p private/frontend/content/wiki
          mkdir -p private/frontend/public/wiki

      - name: Synchronizace content/wiki (MDX) ‚Üí frontend/content/wiki
        run: |
          if [ -d content/wiki ]; then
            rsync -av --delete --exclude='.git' content/wiki/ private/frontend/content/wiki/
          else
            echo "‚ö†Ô∏è Ve zdroji neexistuje slo≈æka content/wiki."
          fi

      - name: Synchronizace public/wiki (assety) ‚Üí frontend/public/wiki
        run: |
          if [ -d public/wiki ]; then
            rsync -av --delete --exclude='.git' public/wiki/ private/frontend/public/wiki/
          else
            echo "‚ö†Ô∏è Ve zdroji neexistuje slo≈æka public/wiki."
          fi

      - name: Commit a push zmƒõn (pouze pokud existuj√≠)
        run: |
          set -e
          cd private
          git add frontend/content/wiki frontend/public/wiki
          
          if git diff --cached --quiet; then
            echo "‚úÖ ≈Ω√°dn√© zmƒõny k odesl√°n√≠."
            exit 0
          fi
          
          git commit -m "Synchronizace wiki: content/wiki + public/wiki (schv√°leno) [skip ci]"
          git push origin main
          echo "üöÄ Zmƒõny √∫spƒõ≈°nƒõ odesl√°ny."